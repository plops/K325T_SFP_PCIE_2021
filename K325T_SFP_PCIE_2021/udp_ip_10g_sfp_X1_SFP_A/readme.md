# UDP/IP 10G SFP Subsystem - Complete Technical Documentation

## System Overview

The `udp_ip_10g_sfp_X1_SFP_A` project implements a complete 10 Gigabit Ethernet UDP/IP communication system on a Kintex-7 325T FPGA with a single SFP+ port. The design provides a loopback test functionality that receives UDP packets and retransmits them back to the network.  

## Hardware Platform Specifications

**Target Device**: Xilinx Kintex-7 xc7k325tiffg676-2L FPGA

**Physical Interfaces**:
- **System Clock**: 100 MHz LVCMOS33 input on pin F17
- **GTX Reference Clock**: 156.25 MHz differential input on pins F6 (P) / F5 (N)
- **SFP+ Port A**: 
  - TX: Differential output pins A4 (P) / A3 (N)
  - RX: Differential input pins B6 (P) / B5 (N)
  - TX Disable: LVCMOS33 control signal on pin D14
- **Reset Button**: SW1 on pin C26
- **Status LEDs**: 4 LEDs (LD1-LD4) on pins A17, A20, B20, A19  

## Top-Level Module Architecture

The top-level module `udp_transmit_test` integrates all system components:

**Module Interface**:
- Input: `key1` (reset button), `clk` (100 MHz), `gtrefclk0_p/n` (156.25 MHz differential), `sfp_rx_p/n` (SFP RX)
- Output: `sfp_tx_p/n` (SFP TX), `sfp_tx_disable` (SFP control), `led 

**LED Status Indicators**:
- LED
- LED[1]: Block lock status
- LED[2]: UDP error flag
- LED 

## Clock Architecture

### Clock Generation Hierarchy

**Primary Clocks**:
1. **System Clock (100 MHz)**: Input clock driving the clock wizard and AXI-Lite interface
2. **GTX Reference Clock (156.25 MHz)**: Differential clock for GTX transceivers
3. **Core Clock (coreclk, 156.25 MHz)**: Generated by the 10G Ethernet core, drives all protocol processing  

### Clock Wizard (clk_wiz_0) Configuration

**Specifications**:
- Input Clock: 100.000 MHz
- Output Clock (clk_out1): 100.000 MHz
- Phase: 0.000 degrees
- Duty Cycle: 50.0%
- Peak-to-Peak Jitter: 130.958 ps
- Phase Error: 98.575 ps
- Input Jitter: 0.010 UI

The clock wizard uses a Mixed-Mode Clock Manager (MMCM) with a `locked` output signal that indicates when the output clock is stable.  

### Clock Domain Crossing

The design uses asynchronous clock groups to prevent false timing paths between the 100 MHz system clock domain and the 156.25 MHz GTX reference clock domain:  

## Reset Architecture

### Reset Generation and Synchronization

The design implements a multi-stage reset architecture:

**Primary Reset Signal**:
- `reset = ~key1` (active high when button not pressed)
- `areset_n = ~reset & mmcm_locked & pcspma_status 

### Reset Synchronizers

Two reset synchronizer modules ensure proper reset distribution:

1. **AXI-Lite Reset Synchronizer**: Synchronizes reset to 100 MHz AXI clock domain
2. **Core Reset Synchronizer**: Synchronizes reset to 156.25 MHz core clock domain  

The synchronizer implements a 7-stage pipeline with 5 asynchronous reset stages followed by 2 synchronous stages:  

## Module Descriptions

### 1. UDP/IP Protocol Stack Module

**Module Name**: `udp_ip_protocol_stack`
**Implementation**: Pre-compiled design checkpoint (.dcp file)

**Configuration Parameters**:

| Parameter | Value | Description |
|-----------|-------|-------------|
| LOCAL_PORT_NUM | 16'hf000 (61440) | Local UDP listening port |
| LOCAL_IP_ADDRESS | 32'hc0a80a01 (192.168.10.1) | Local IPv4 address |
| LOCAL_MAC_ADDRESS | 48'h000a35000102 | Local MAC address |
| ICMP_EN | 1'b1 | Enable ICMP echo reply |
| ARP_REPLY_EN | 1'b1 | Enable ARP reply generation |
| ARP_REQUEST_EN | 1'b1 | Enable ARP request transmission |
| ARP_TIMEOUT_VALUE | 30'd20_000_000 (~128ms @ 156.25MHz) | ARP cache timeout |
| ARP_RETRY_NUM | 4'd2 | ARP request retry count |  

**Application Layer Interface (Transmit)**:

| Signal | Width | Direction | Description |
|--------|-------|-----------|-------------|
| app_tx_request | 1 | Input | Request UDP transmission |
| app_tx_ack | 1 | Output | Acknowledge transmission request |
| udp_tx_ready | 1 | Output | Stack ready for new requests |
| app_tx_data_valid | 1 | Input | Data valid strobe |
| app_tx_data | 64 | Input | Transmit data payload |
| app_tx_data_keep | 8 | Input | Byte enable mask |
| app_tx_data_last | 1 | Input | Last data word indicator |
| app_tx_data_length | 16 | Input | UDP payload length in bytes |
| app_tx_dst_port | 16 | Input | Destination UDP port (0xf001) |
| ip_tx_dst_address | 32 | Input | Destination IP (192.168.10.2) |  

**Application Layer Interface (Receive)**:

| Signal | Width | Direction | Description |
|--------|-------|-----------|-------------|
| app_rx_data_valid | 1 | Output | Received data valid |
| app_rx_data | 64 | Output | Received UDP payload |
| app_rx_data_keep | 8 | Output | Byte enable mask |
| app_rx_data_last | 1 | Output | Last data word |
| app_rx_data_length | 16 | Output | UDP payload length |
| app_rx_port_num | 16 | Output | Source UDP port |  

**MAC Layer Interface**:

The protocol stack connects to the MAC layer using AXI-Stream interfaces with 64-bit data width:  

### 2. 10G Ethernet Core (axi_10g_ethernet_0)

**Core Type**: Xilinx AXI 10G Ethernet Subsystem
**Implementation**: 10GBASE-R with MAC and PCS/PMA layers

**Key Features**:
- IEEE 802.3 Clause 49 (10GBASE-R) compliance
- 64b/66b encoding in PCS layer
- GTX transceiver-based physical layer
- AXI-Stream data interface (64-bit @ 156.25 MHz)
- AXI-Lite configuration interface
- MDIO management interface (IEEE 802.3 Clause 45)

**Core Instantiation Parameters**:  

**Data Path Interfaces**:
- TX AXI-Stream: 64-bit data, TVALID/TREADY handshake, TKEEP, TLAST
- RX AXI-Stream: 64-bit data, TVALID, TKEEP, TLAST, TUSER (error indicator)
- Inter-frame gap delay: 8'd0 (minimum legal IFG)  

### 3. AXI-Lite Configuration State Machine (axi_10g_ethernet_0_axi_lite_sm)

This module implements a sophisticated three-level state machine hierarchy for Ethernet core initialization:

**State Machine Levels**:

1. **Main Configuration State Machine** (16 states): Orchestrates the overall configuration sequence
2. **MDIO Access State Machine** (4 states): Manages MDIO protocol operations
3. **AXI Protocol State Machine** (4 states): Handles AXI-Lite channel transactions  

**Configuration Register Map**:

| Register | Address | Function |
|----------|---------|----------|
| CONFIG_MANAGEMENT_ADDR | 0x500 | MDIO management (MDC frequency) |
| RECEIVER_ADDR | 0x404 | MAC receiver configuration |
| TRANSMITTER_ADDR | 0x408 | MAC transmitter configuration |
| MDIO_CONTROL | 0x504 | MDIO control operations |
| MDIO_TX_DATA | 0x508 | MDIO transmit data |
| MDIO_RX_DATA | 0x50C | MDIO receive data |  

**MDIO Configuration**:
- Port Address: 5'h00
- Device Address: 5'h03 (PCS device)
- MDC Frequency: 10.4 MHz (clock divider = 5 from 125 MHz AXI clock)
- Operations: Address, Write, Read, Read-with-increment  

**Configuration Sequence**:

1. Set MDC frequency (write 0x45 to CONFIG_MANAGEMENT_ADDR)
2. Reset MAC receiver and transmitter
3. Configure PCS via MDIO (BASE-R Control 1 register)
4. Poll PCS status for block lock (BASE-R Status 1 = 0x11005)
5. Assert `enable_gen` when configuration complete  

### 4. Buffering Architecture (Three-Tier FIFO System)

#### UDP Packet FIFO (udp_packet_fifo)

**Type**: Standard dual-clock FIFO
**Depth**: 512 words × 64 bits (4 KB storage)
**Purpose**: Application-level packet storage for loopback operation

**Signal Connections**:
- Write Clock: `coreclk` (156.25 MHz)
- Read Clock: `coreclk` (156.25 MHz)
- Write Enable: `app_rx_data_valid` (from UDP stack)
- Read Enable: `app_tx_data_read` (from state machine)
- Status: `rd_data_count 

#### TX Packet FIFO (tx_packet_fifo0)

**Type**: AXI-Stream Data FIFO (axis_data_fifo_0)
**Purpose**: Buffer packets from UDP stack to Ethernet MAC

**Configuration**:
- Data Width: 64 bits
- Sideband Signals: TKEEP[7:0], TLAST, TUSER
- Clock: `coreclk` (156.25 MHz synchronous)
- Reset: Active-low (`~core_reset`)  

#### RX Packet FIFO (rx_packet_fifo0)

**Type**: AXI-Stream Data FIFO (axis_data_fifo_0)
**Purpose**: Buffer packets from Ethernet MAC to UDP stack

**Operating Mode**: Free-running (master side always ready with `m_axis_tready = 1'b1`)  

### 5. Loopback State Machine

The design implements a 4-state FSM to manage UDP packet loopback:

**States**:
- `WAIT_UDP_DATA (2'd0)`: Wait for received data in FIFO
- `WAIT_ACK (2'd1)`: Request transmission and wait for UDP stack acknowledgment
- `SEND_UDP_DATA (2'd2)`: Stream data to UDP stack
- `DELAY (2'd3)`: Wait between packets  

**State Machine Logic**:

The FSM monitors the `udp_packet_fifo_data_cnt` to detect available data, requests transmission from the UDP stack, and manages the FIFO read process with proper `tkeep` and `tlast` signal generation:  

**Byte Enable Calculation**:

The state machine calculates proper byte enables for the last transfer based on payload length:
- For packets ≤8 bytes: `app_tx_data_keep = 8'hff >> (8 - udp_data_length)`
- For multi-word packets: `app_tx_data_keep = 8'hff >> (fifo_read_data_cnt + 8 - udp_data_length)`  

### 6. Synchronization Modules

**Block Lock Synchronizer**: Transfers the `block_lock` signal from the Ethernet core to the `coreclk` domain using a 5-stage synchronizer:  

The synchronizer uses shift register extraction prevention and async register attributes:  

## Data Flow Architecture

### Complete RX-to-TX Loopback Path

1. **Physical Reception**: SFP+ receives 10GBASE-R serial data via GTX transceiver
2. **PCS/MAC Processing**: Ethernet core decodes 64b/66b, performs block synchronization, and outputs AXI-Stream frames
3. **RX FIFO Buffering**: `rx_packet_fifo0` buffers incoming frames
4. **Protocol Processing**: UDP/IP stack extracts UDP payload for port 0xf000
5. **Application Storage**: `udp_packet_fifo` stores received payload
6. **State Machine Control**: FSM detects available data and initiates retransmission
7. **Protocol Encapsulation**: UDP/IP stack adds headers for destination 192.168.10.2:0xf001
8. **TX FIFO Buffering**: `tx_packet_fifo0` buffers outgoing frames
9. **MAC/PCS Processing**: Ethernet core adds FCS, performs 64b/66b encoding
10. **Physical Transmission**: GTX transceiver sends 10GBASE-R serial data via SFP+

### Throughput Specifications

**Theoretical Maximum**: 10 Gbps line rate (156.25 MHz × 64 bits)
**Practical Throughput**: Depends on packet size and protocol overhead

- Minimum Ethernet frame: 64 bytes (42 bytes overhead + 22 bytes minimum payload)
- UDP/IP/Ethernet overhead: 42 bytes (14 Ethernet + 20 IP + 8 UDP)
- Maximum UDP payload: 1472 bytes (MTU 1500 - 20 IP - 8 UDP)

## Physical Layer Specifications

### 10GBASE-R Implementation

**Standard Compliance**: IEEE 802.3 Clause 49
**Line Rate**: 10.3125 Gbps (156.25 MHz × 66 bits)
**Encoding**: 64b/66b block encoding
**PCS Synchronization**: Block lock mechanism monitored via MDIO

**PCS Control Registers** (accessed via MDIO, Device Address 0x03):
- BASE-R Control 1 (Reg 0x00): 
  - Normal operation: 0x2000
  - Loopback mode: 0x4000
  - Reset: 0x8000
- BASE-R Status 1 (Reg 0x20):
  - Block lock achieved: bit pattern 0x11005  

### GTX Transceiver Configuration

The design uses Kintex-7 GTX transceivers with:
- Reference clock: 156.25 MHz differential input
- Serial line rate: 10.3125 Gbps
- Signal detect: Tied to 1'b1 (assumes SFP+ module has valid signal)
- TX fault input: Tied to 1'b0 (no fault detection)  

## Error Handling

### Error Detection Signals

**UDP/IP Layer Errors**:
- `udp_rx_error`: UDP checksum or length validation failure
- `ip_rx_error`: IP header checksum or version error
- `dst_ip_unreachable`: ARP resolution failed after retries  

**Error Flag Register**: The `udp_error_flag` register captures and holds UDP errors for LED display:  

### Physical Layer Status

**PCS/PMA Status Vector** (`pcspma_status: 8-bit status from Ethernet core
- Bit 

## Bitstream Configuration

The design includes specific bitstream generation settings optimized for Quad SPI flash configuration:

- Compression: Enabled
- Configuration rate: 66 MHz
- SPI bus width: 4 (Quad SPI)
- 32-bit SPI addressing: Yes
- Configuration voltage: 2.5V
- Unused pins: Pull-up  

## Summary

The `udp_ip_10g_sfp_X1_SFP_A` project implements a complete, production-ready 10 Gigabit Ethernet UDP/IP subsystem featuring:

- Full 10GBASE-R physical layer with GTX transceivers
- Standards-compliant MAC/PCS layers with MDIO management
- Complete UDP/IP protocol stack with ARP and ICMP support
- Three-tier FIFO buffering architecture for data rate matching
- Sophisticated initialization state machine with PCS configuration
- Loopback test functionality demonstrating end-to-end operation
- Comprehensive error detection and status monitoring
- Robust clock domain crossing and reset synchronization

The design operates at the full 10 Gbps line rate and provides a solid foundation for high-speed network applications on Xilinx Kintex-7 FPGAs.


